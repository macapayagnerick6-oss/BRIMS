<div class="users-roles-page">
  <div class="page-header">
    <h1 class="page-title">Users & Roles</h1>
  </div>

  <div class="tabs-wrapper">
    <nav class="tabs" role="tablist">
      <button
        type="button"
        class="tab-button"
        [class.active]="activeTab === 'users'"
        (click)="setActiveTab('users')"
        role="tab"
        [attr.aria-selected]="activeTab === 'users'"
      >
        Users ({{ users.length }})
      </button>
      <button
        type="button"
        class="tab-button"
        [class.active]="activeTab === 'roles'"
        (click)="setActiveTab('roles')"
        role="tab"
        [attr.aria-selected]="activeTab === 'roles'"
      >
        Roles ({{ roles.length }})
      </button>
    </nav>
  </div>

  <div class="tab-content">
    <!-- Users Tab -->
    <div *ngIf="activeTab === 'users'" class="users-tab">
      <div class="filters filters--with-action">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Search by Name or Email" 
          [(ngModel)]="search" 
        />
        <select class="form-control" [(ngModel)]="roleFilter">
          <option value="">All Roles</option>
          <option value="Admin">Admin</option>
          <option value="Staff">Staff</option>
          <option value="Resident">Resident</option>
        </select>
        <select class="form-control" [(ngModel)]="statusFilter">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
        <button type="button" class="btn btn--primary" (click)="openAddUserForm()">+ Add User</button>
      </div>

      <div class="card add-user-card" *ngIf="showAddUserForm">
        <div class="add-user-header">
          <div>
            <h2>Add New User</h2>
            <p class="muted">Create a new account for staff or residents.</p>
          </div>
        </div>

        <div class="add-user-grid">
          <div class="form-group">
            <label>Full Name</label>
            <input
              type="text"
              class="form-control"
              placeholder="Enter full name"
              [(ngModel)]="newUser.name"
            />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              class="form-control"
              placeholder="name@example.com"
              [(ngModel)]="newUser.email"
            />
          </div>
          <div class="form-group">
            <label>Role</label>
            <select
              class="form-control"
              [(ngModel)]="newUser.role"
            >
              @for (role of roles; track role.id) {
                <option [value]="role.name">{{ role.name }}</option>
              }
            </select>
          </div>
          <div class="form-group" *ngIf="newUser.role === 'Staff' || newUser.role === 'Admin'">
            <label>Password <span class="required">*</span></label>
            <input
              type="password"
              class="form-control"
              placeholder="Login password for this user"
              [(ngModel)]="newUser.password"
              autocomplete="new-password"
            />
            <small class="muted">Required so this user can log in to the staff portal.</small>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select
              class="form-control"
              [(ngModel)]="newUser.status"
            >
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>

        <div class="add-user-footer">
          <p class="error-text" *ngIf="addUserError">
            {{ addUserError }}
          </p>
          <span class="spacer"></span>
          <button
            type="button"
            class="btn btn--outline btn--sm"
            (click)="closeAddUserForm()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn--primary btn--sm"
            (click)="submitNewUser()"
          >
            Save User
          </button>
        </div>
      </div>

      <div class="table-wrap card">
        <table class="table">
          <thead>
            <tr>
              <th><input type="checkbox" /></th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (user of filteredUsers; track user.id) {
              <tr>
                <td><input type="checkbox" /></td>
                <td><strong>{{ user.name }}</strong></td>
                <td>{{ user.email }}</td>
                <td>
                  <select 
                    class="role-select" 
                    [value]="user.role"
                    (change)="updateUserRole(user.id, $any($event.target).value)"
                  >
                    @for (role of roles; track role.id) {
                      <option [value]="role.name">{{ role.name }}</option>
                    }
                  </select>
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(user.status)">
                    {{ user.status }}
                  </span>
                </td>
                <td>{{ user.lastLogin || 'Never' }}</td>
                <td>{{ user.createdAt }}</td>
                <td>
                  <button 
                    type="button" 
                    class="btn btn--sm"
                    [ngClass]="user.status === 'Active' ? 'btn--outline' : 'btn--success'"
                    (click)="toggleUserStatus(user.id)"
                  >
                    {{ user.status === 'Active' ? 'Deactivate' : 'Activate' }}
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--color-text-muted);">
                  No users found
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Roles Tab -->
    <div *ngIf="activeTab === 'roles'" class="roles-tab">
      <div class="roles-grid">
        @for (role of roles; track role.id) {
          <div class="role-card card">
            <div class="role-header">
              <div>
                <h3>{{ role.name }}</h3>
                <p class="role-description">{{ role.description }}</p>
              </div>
              <span class="badge badge--info">{{ role.userCount }} user{{ role.userCount !== 1 ? 's' : '' }}</span>
            </div>
            <div class="permissions">
              <h4>Permissions:</h4>
              <ul class="permissions-list">
                @for (permission of role.permissions; track permission) {
                  <li>{{ permission }}</li>
                }
              </ul>
            </div>
            <div class="role-actions">
              <button
                type="button"
                class="btn btn--outline role-edit-btn"
                (click)="openRoleModal(role, 'role')"
              >
                Edit Role & Permissions
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
  
  @if (showRoleModal && activeRole) {
    <div class="modal-overlay" (click)="closeRoleModal()">
      <div class="modal card" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">
            Edit Role – {{ activeRole.name }}
          </h2>
          <button
            type="button"
            class="modal-close"
            (click)="closeRoleModal()"
            aria-label="Close"
          >
            &times;
          </button>
        </div>

        <form class="modal-body" (ngSubmit)="saveRoleModal()">
          <p class="muted modal-desc">
            Update the description and permissions for this role.
          </p>

          <div class="form-group">
            <label>Role name</label>
            <input
              type="text"
              class="form-control"
              [value]="activeRole.name"
              disabled
            />
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea
              class="form-control"
              rows="3"
              [(ngModel)]="modalDescription"
              name="roleDescription"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Permissions</label>
            <div class="permissions-tags">
              @for (perm of modalPermissions; track perm) {
                <span class="permission-tag">
                  {{ perm }}
                  <button
                    type="button"
                    class="permission-remove"
                    (click)="removePermission($index)"
                  >
                    ×
                  </button>
                </span>
              } @empty {
                <p class="muted">No permissions configured yet.</p>
              }
            </div>
          </div>

          <div class="form-group permissions-add">
            <input
              type="text"
              class="form-control"
              placeholder="Enter permission then press Add"
              [(ngModel)]="newPermission"
              (keyup.enter)="addPermission()"
              name="newPermission"
            />
            <button
              type="button"
              class="btn btn--sm btn--outline"
              (click)="addPermission()"
            >
              Add
            </button>
          </div>

          <div class="modal-actions">
            <button
              type="button"
              class="btn btn--outline"
              (click)="closeRoleModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn--primary">
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
